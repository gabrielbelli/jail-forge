---
# Main tasks for jail-base role
- name: Check if jail already exists
  command: jls -j {{ jail_name }}
  register: jail_check
  changed_when: false
  failed_when: false

- name: Create ZFS dataset for jail
  community.general.zfs:
    name: "{{ jail_zfs_dataset }}"
    state: present
    extra_zfs_properties:
      mountpoint: "{{ jail_path }}"
      compression: lz4
      quota: 10G
  when: jail_zfs_enabled

- name: Clone base system to jail
  shell: >
    cp -Rp {{ jail_base_path }}/* {{ jail_path }}/
  args:
    creates: "{{ jail_path }}/bin"
  when: jail_check.rc != 0

- name: Create jail directories
  file:
    path: "{{ jail_path }}/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - dev
    - tmp
    - var/tmp
  when: jail_check.rc != 0

- name: Set proper permissions on jail directories
  file:
    path: "{{ jail_path }}/{{ item.path }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: 'tmp', mode: '1777' }
    - { path: 'var/tmp', mode: '1777' }
  when: jail_check.rc != 0

- name: Configure jail resolv.conf
  copy:
    src: /etc/resolv.conf
    dest: "{{ jail_path }}/etc/resolv.conf"
    remote_src: yes

- name: Create fstab directory on host
  file:
    path: "/usr/local/etc/jail.fstab.d"
    state: directory
    mode: '0755'
  when: jail_mounts | length > 0

- name: Create host-side mount directories
  file:
    path: "{{ item.src }}"
    state: directory
    mode: '0755'
  loop: "{{ jail_mounts }}"
  when: jail_mounts | length > 0

- name: Create jail-side mount points
  file:
    path: "{{ jail_path }}{{ item.dest }}"
    state: directory
    mode: '0755'
  loop: "{{ jail_mounts }}"
  when: jail_mounts | length > 0

- name: Create jail fstab file
  template:
    src: fstab.j2
    dest: "/usr/local/etc/jail.fstab.d/{{ jail_name }}.fstab"
    mode: '0644'
  when: jail_mounts | length > 0

- name: Create jail configuration file
  template:
    src: jail-config.conf.j2
    dest: "/usr/local/etc/jail.conf.d/{{ jail_name }}.conf"
    mode: '0644'

- name: Rebuild /etc/jail.conf from individual configs
  shell: |
    echo "# Main jail.conf configuration" > /etc/jail.conf
    echo "# Managed by Ansible - DO NOT EDIT MANUALLY" >> /etc/jail.conf
    echo "# Individual jail configurations are in /usr/local/etc/jail.conf.d/" >> /etc/jail.conf
    echo "# This file is rebuilt automatically from those configs" >> /etc/jail.conf
    echo "" >> /etc/jail.conf
    cat /usr/local/etc/jail.conf.d/*.conf >> /etc/jail.conf 2>/dev/null || true
  changed_when: true

- name: Start jail
  command: jail -f /etc/jail.conf -c {{ jail_name }}
  when: jail_check.rc != 0
  register: jail_start
  failed_when: false

- name: Check if jail started successfully
  command: jls -j {{ jail_name }}
  register: jail_verify
  failed_when: jail_verify.rc != 0
  changed_when: false
  when: jail_check.rc != 0

- name: Cleanup failed mounts if jail failed to start
  shell: |
    mount | grep "{{ jail_path }}" | awk '{print $3}' | xargs -n1 umount -f 2>/dev/null || true
  when: jail_check.rc != 0 and jail_verify.rc != 0
  ignore_errors: yes

- name: Wait for jail to be fully started
  wait_for:
    timeout: 5
  delegate_to: localhost
  when: jail_check.rc != 0 and jail_verify.rc == 0

- name: Update jail to latest patches
  command: >
    jexec {{ jail_name }}
    freebsd-update --not-running-from-cron fetch install
  register: jail_update
  changed_when: "'No updates' not in jail_update.stdout"
  failed_when: false

- name: Bootstrap pkg in jail
  command: jexec {{ jail_name }} env ASSUME_ALWAYS_YES=yes pkg bootstrap
  args:
    creates: "{{ jail_path }}/usr/local/sbin/pkg"

- name: Update pkg database in jail
  command: jexec {{ jail_name }} pkg update -f
  changed_when: false

- name: Install base packages in jail
  command: >
    jexec {{ jail_name }} pkg install -y
    python311 py311-pip ca_root_nss curl bash

- name: Configure jail rc.conf
  template:
    src: rc.conf.j2
    dest: "{{ jail_path }}/etc/rc.conf"
    mode: '0644'

- name: Add jail to autostart list
  command: sysrc -f /etc/rc.conf.d/jail jail_list+="{{ jail_name }}"
  when: jail_autostart
  register: sysrc_result
  changed_when: "'jail_list:' in sysrc_result.stdout"
  failed_when: false

- name: Display jail information
  debug:
    msg:
      - "Jail {{ jail_name }} created successfully"
      - "IP Address: {{ jail_ip }}"
      - "Path: {{ jail_path }}"
      - "Access: jexec {{ jail_name }} /bin/sh"
