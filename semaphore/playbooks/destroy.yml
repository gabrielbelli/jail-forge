---
# Destroy all jails and clean up
- name: Destroy Semaphore Infrastructure
  hosts: jail_hosts
  gather_facts: true
  vars_files:
    - ../group_vars/all/vars.yml
    - ../group_vars/all/secrets.yml

  tasks:
    - name: Confirm destruction
      pause:
        prompt: |
          ⚠️  WARNING: This will destroy all Semaphore jails and data!

          This action will:
          - Stop all running jails
          - Destroy semaphore-app jail
          - Destroy semaphore-db jail (INCLUDING DATABASE)
          - Remove jail configurations

          Type 'yes' to confirm destruction
      register: destruction_confirmation
      when: confirm_destroy is not defined

    - name: Validate confirmation
      assert:
        that:
          - (destruction_confirmation.user_input | default('no') | lower == 'yes') or (confirm_destroy | default('no') | lower == 'yes')
        fail_msg: "Destruction cancelled by user"
        success_msg: "Proceeding with destruction"

    - name: Stop Semaphore service
      command: jexec semaphore-app service semaphore stop
      ignore_errors: yes

    - name: Stop PostgreSQL service
      command: jexec semaphore-db service postgresql stop
      ignore_errors: yes

    - name: Wait for services to stop
      pause:
        seconds: 3

    - name: Stop jails using service
      command: service jail stop
      ignore_errors: yes

    - name: Wait for jails to stop
      pause:
        seconds: 3

    - name: Check if jails are still running
      shell: jls -j semaphore-app || jls -j semaphore-db
      register: jail_still_running
      failed_when: false
      changed_when: false

    - name: Force stop jails if still running
      shell: |
        jail -r semaphore-app 2>/dev/null || true
        jail -r semaphore-db 2>/dev/null || true
      when: jail_still_running.rc == 0
      ignore_errors: yes

    - name: Wait for mounts to be released
      pause:
        seconds: 2

    - name: Check for remaining nullfs mounts
      shell: mount -t nullfs | grep -E "(semaphore-app|semaphore-db)" || true
      register: remaining_mounts
      changed_when: false

    - name: Display remaining mounts
      debug:
        msg: "{{ remaining_mounts.stdout_lines }}"
      when: remaining_mounts.stdout != ""

    - name: Force unmount any remaining nullfs mounts
      shell: |
        mount -t nullfs | grep "semaphore-app" | awk '{print $3}' | xargs -n1 umount -f 2>/dev/null || true
        mount -t nullfs | grep "semaphore-db" | awk '{print $3}' | xargs -n1 umount -f 2>/dev/null || true
      when: remaining_mounts.stdout != ""
      ignore_errors: yes

    - name: Force unmount devfs mounts
      shell: |
        mount | grep "semaphore-app/dev" | awk '{print $3}' | xargs -n1 umount -f 2>/dev/null || true
        mount | grep "semaphore-db/dev" | awk '{print $3}' | xargs -n1 umount -f 2>/dev/null || true
      ignore_errors: yes

    - name: Remove jail configurations
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /usr/local/etc/jail.conf.d/semaphore-app.conf
        - /usr/local/etc/jail.conf.d/semaphore-db.conf
        - /usr/local/etc/jail.fstab.d/semaphore-app.fstab
        - /usr/local/etc/jail.fstab.d/semaphore-db.fstab

    - name: Remove jail from autostart list
      command: sysrc -f /etc/rc.conf.d/jail jail_list-="{{ item }}"
      loop:
        - semaphore-app
        - semaphore-db
      register: sysrc_result
      changed_when: "'jail_list:' in sysrc_result.stdout"
      failed_when: false

    - name: Rebuild /etc/jail.conf from remaining configs
      shell: |
        echo "# Main jail.conf configuration" > /etc/jail.conf
        echo "# Managed by Ansible - DO NOT EDIT MANUALLY" >> /etc/jail.conf
        echo "# Individual jail configurations are in /usr/local/etc/jail.conf.d/" >> /etc/jail.conf
        echo "# This file is rebuilt automatically from those configs" >> /etc/jail.conf
        echo "" >> /etc/jail.conf
        cat /usr/local/etc/jail.conf.d/*.conf >> /etc/jail.conf 2>/dev/null || true
      changed_when: true

    - name: Destroy ZFS datasets (optional - commented for safety)
      debug:
        msg: |
          To completely remove data, run:
          zfs destroy -r {{ zfs_pool }}/{{ jail_dataset }}/data/db
          zfs destroy -r {{ zfs_pool }}/{{ jail_dataset }}/data/semaphore
      # Uncomment below to automatically destroy data
      # community.general.zfs:
      #   name: "{{ item }}"
      #   state: absent
      # loop:
      #   - "{{ zfs_pool }}/{{ jail_dataset }}/data/semaphore"
      #   - "{{ zfs_pool }}/{{ jail_dataset }}/data/db"

    - name: Display destruction summary
      debug:
        msg:
          - "✓ Jails stopped and configurations removed"
          - ""
          - "To completely remove data, manually run:"
          - "  zfs destroy -r {{ zfs_pool }}/{{ jail_dataset }}/data/db"
          - "  zfs destroy -r {{ zfs_pool }}/{{ jail_dataset }}/data/semaphore"
